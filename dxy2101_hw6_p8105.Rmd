---
title: "dxy2101_hw6_p8105"
author: "Daisy Yan"
date: "2022-12-03"
output: github_document
---

```{r setup, message=FALSE}
library(tidyverse)
library(ggplot2)

set.seed(1)
```

## Problem 2

Load and prepare homicide data.

```{r homicides, message=FALSE, warning=FALSE}
# Load data
url = 'https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv'

homicide_data = read_csv(url)

# Create new variables and clean
homicide_data =
  homicide_data %>%
  mutate(city_state = str_c(city, state, sep = ", "),
         status = case_when(
           disposition == "Closed without arrest" ~ "unsolved",
           disposition == "Open/No arrest" ~ "unsolved",
           disposition == "Closed by arrest" ~ "solved"
         )) %>%
  select(-city, -state, -disposition) %>%
  relocate(city_state, .before = lat) %>%
  subset(city_state != "Dallas, TX" & city_state != "Phoenix, AZ"
         & city_state != "Kansas City, MO" & city_state != "Tulsa, AL") %>%
  filter(victim_race == "White" | victim_race == "Black") %>%
  mutate(victim_age = as.numeric(victim_age))
```

For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors.

```{r logistic}
# Filter for Baltimore, MD
baltimore_df =
  homicide_data %>%
  filter(city_state == "Baltimore, MD") %>%
  mutate(
    resolved = as.numeric(status == "solved"),
    victim_race = fct_relevel(victim_race, "White")) %>% 
  select(resolved, victim_age, victim_race, victim_sex)

# Fit logistic regression
fit_logistic = 
  baltimore_df %>% 
  glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()) %>%
  broom::tidy(conf.int = TRUE)

# Obtain estimate and CI of OR
fit_logistic %>% 
  mutate(
    OR = exp(estimate),
    low.lim = exp(conf.low),
    up.lim = exp(conf.high)) %>%
  select(term, OR, low.lim, up.lim) %>% 
  knitr::kable(digits = 3)
```

The odds ratio for solving homicides comparing male victims to female victims, controlling for age and race, is 0.426 (95% CI: 0.324, 0.558).

Now, run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing male victims to female victims.

```{r glm_all, message=FALSE, warning=FALSE}
glm_cities = 
  homicide_data %>%
  mutate(
    resolved = as.numeric(status == "solved"),
    victim_race = fct_relevel(victim_race, "White")) %>%
  nest(data = -city_state) %>% 
  mutate(
    fit_logistic = map(data, ~glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial())),
    output = map(.x = fit_logistic, ~broom::tidy(.x,conf.int = TRUE))) %>% 
  select(city_state, output) %>% 
  unnest(output) %>% 
  mutate(
    OR = exp(estimate),
    low.lim = exp(conf.low),
    up.lim = exp(conf.high)) %>%
  select(city_state, term, OR, low.lim, up.lim) %>%
  filter(term == "victim_sexMale")

glm_cities %>%
  knitr::kable(digits = 3)
```

Create a plot that shows the estimated ORs and CIs for each city.

```{r plot, message=FALSE, warning=FALSE}
glm_cities %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) + geom_point() + 
  geom_errorbar(aes(ymin = low.lim, ymax = up.lim), width = 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("City, State") + ylab("OR of Solved Homicides") +
  ggtitle("Odds ratio and 95% CI of Solved Homicides by City, State")
```

According to the plot, New York, NY has the lowest odds ratio for solving homicides comparing male victims to female victims, controlling for age and race, while Albuquerque, NM has the highest odds ratio for solving homicides comparing male victims to female victims, controlling for age and race. Albuquerque, NM also has the greatest 95% confidence interval for the odds ratio, suggesting greater variability in its data. 


